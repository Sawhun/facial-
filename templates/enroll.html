{% extends "base.html" %}

{% block title %}Enroll Employee - MediCare Attendance System{% endblock %}

{% block extra_css %}
<style>
    .face-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
        z-index: 10;
    }

    .face-detected {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(34, 211, 238, 0.9) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .face-not-detected {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(249, 115, 22, 0.9) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }

    .webcam-container {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    }

    .webcam-video {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        display: block;
    }

    .webcam-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 15, 35, 0.85);
        backdrop-filter: blur(10px);
    }

    .quality-meter {
        height: 8px;
        border-radius: 50px;
        overflow: hidden;
        background: rgba(99, 102, 241, 0.2);
    }

    .quality-bar {
        height: 100%;
        border-radius: 50px;
        transition: width 0.3s ease, background 0.3s ease;
    }

    .quality-bar.good {
        background: linear-gradient(90deg, #10b981 0%, #22d3ee 100%);
    }

    .quality-bar.medium {
        background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
    }

    .quality-bar.poor {
        background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
    }

    .capture-btn {
        padding: 1rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .capture-btn:hover {
        transform: translateY(-2px);
    }

    .capture-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .preview-container {
        border-radius: 12px;
        overflow: hidden;
        border: 3px solid rgba(99, 102, 241, 0.3);
    }

    .tips-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 16px;
    }

    [data-bs-theme="dark"] .tips-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
    }

    .tip-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 8px 0;
    }

    .tip-item i {
        color: var(--primary);
        font-size: 1.1rem;
        margin-top: 2px;
    }

    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.05);
    }

    .divider {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .divider::before,
    .divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-color);
    }

    .divider span {
        color: var(--text-muted);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-title mb-4">
    <h2 class="fw-bold mb-1">
        <i class="bi bi-person-plus"></i>
        Enroll New Employee
    </h2>
    <p class="text-muted mb-0">Register a new employee with facial recognition</p>
</div>

<div class="row g-4">
    <!-- Face Capture Section -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-camera-video text-gradient"></i>
                    Face Capture
                </h5>
            </div>
            <div class="card-body">
                <!-- Webcam Container -->
                <div class="webcam-container mb-3">
                    <video id="webcam" autoplay playsinline class="webcam-video"></video>
                    <canvas id="canvas" style="display: none;"></canvas>

                    <!-- Face Detection Indicator -->
                    <div id="faceIndicator" class="face-indicator face-not-detected" style="display: none;">
                        <i class="bi bi-person-bounding-box"></i>
                        <span id="faceStatus">No face detected</span>
                    </div>

                    <!-- Loading Overlay -->
                    <div id="webcamOverlay" class="webcam-overlay">
                        <div class="text-center text-white">
                            <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                            <p class="mb-0 fw-medium">Initializing camera...</p>
                            <small class="opacity-75">Please allow camera access</small>
                        </div>
                    </div>
                </div>

                <!-- Quality Indicators -->
                <div id="qualityIndicators" class="mb-4" style="display: none;">
                    <div class="row g-3">
                        <div class="col-4">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted fw-medium">Brightness</small>
                                <small id="brightnessValue" class="text-muted">0%</small>
                            </div>
                            <div class="quality-meter">
                                <div id="brightnessBar" class="quality-bar good" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted fw-medium">Sharpness</small>
                                <small id="sharpnessValue" class="text-muted">0%</small>
                            </div>
                            <div class="quality-meter">
                                <div id="sharpnessBar" class="quality-bar good" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted fw-medium">Face Size</small>
                                <small id="faceSizeValue" class="text-muted">0%</small>
                            </div>
                            <div class="quality-meter">
                                <div id="faceSizeBar" class="quality-bar good" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capture Buttons -->
                <div class="d-flex gap-2 mb-3">
                    <button type="button" id="captureBtn" class="btn btn-primary capture-btn flex-grow-1" disabled>
                        <i class="bi bi-camera me-2"></i>Capture Photo
                    </button>
                    <button type="button" id="retakeBtn" class="btn btn-outline-secondary capture-btn" style="display: none;">
                        <i class="bi bi-arrow-clockwise me-2"></i>Retake
                    </button>
                </div>

                <!-- Divider -->
                <div class="divider">
                    <span>or upload</span>
                </div>

                <!-- Upload Zone -->
                <label for="uploadImage" class="upload-zone d-block mb-3">
                    <i class="bi bi-cloud-arrow-up fs-2 text-muted mb-2 d-block"></i>
                    <span class="text-muted">Click to upload or drag & drop</span>
                    <input type="file" class="d-none" id="uploadImage" accept="image/*">
                </label>

                <!-- Preview -->
                <div id="capturedPreview" style="display: none;">
                    <label class="form-label fw-semibold">Captured Photo</label>
                    <div class="preview-container">
                        <img id="previewImage" class="w-100" style="max-height: 200px; object-fit: cover;">
                    </div>
                    <div id="validationResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Information Section -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-person-vcard text-gradient"></i>
                    Employee Information
                </h5>
            </div>
            <div class="card-body">
                <form id="enrollForm" method="POST" action="{{ url_for('enroll') }}">
                    <input type="hidden" id="imageData" name="image_data">

                    <!-- Employee ID -->
                    <div class="mb-3">
                        <label for="employeeId" class="form-label fw-semibold">
                            <i class="bi bi-hash me-1"></i>Employee ID
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="employeeId" name="employee_id" required placeholder="e.g., EMP001">
                        <div class="form-text">Unique identifier for the employee</div>
                    </div>

                    <!-- Full Name -->
                    <div class="mb-3">
                        <label for="fullName" class="form-label fw-semibold">
                            <i class="bi bi-person me-1"></i>Full Name
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="fullName" name="full_name" required placeholder="Enter full name">
                    </div>

                    <!-- Department -->
                    <div class="mb-4">
                        <label for="department" class="form-label fw-semibold">
                            <i class="bi bi-building me-1"></i>Department
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select form-select-lg" id="department" name="department" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Tips Card -->
                    <div class="tips-card p-4 mb-4">
                        <h6 class="fw-bold mb-3 d-flex align-items-center gap-2">
                            <i class="bi bi-lightbulb text-warning"></i>
                            Tips for Best Results
                        </h6>
                        <div class="tip-item">
                            <i class="bi bi-sun"></i>
                            <span>Ensure good, even lighting on the face</span>
                        </div>
                        <div class="tip-item">
                            <i class="bi bi-eye"></i>
                            <span>Look directly at the camera</span>
                        </div>
                        <div class="tip-item">
                            <i class="bi bi-eyeglasses"></i>
                            <span>Remove glasses if possible</span>
                        </div>
                        <div class="tip-item">
                            <i class="bi bi-emoji-neutral"></i>
                            <span>Keep a neutral expression</span>
                        </div>
                        <div class="tip-item">
                            <i class="bi bi-aspect-ratio"></i>
                            <span>Face should fill most of the frame</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn" class="btn btn-success btn-lg w-100" disabled>
                        <span id="submitText">
                            <i class="bi bi-check-circle me-2"></i>Enroll Employee
                        </span>
                        <span id="submitSpinner" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-2"></span>Processing...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const uploadImage = document.getElementById('uploadImage');
    const imageData = document.getElementById('imageData');
    const previewImage = document.getElementById('previewImage');
    const capturedPreview = document.getElementById('capturedPreview');
    const webcamOverlay = document.getElementById('webcamOverlay');
    const submitBtn = document.getElementById('submitBtn');
    const enrollForm = document.getElementById('enrollForm');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const faceIndicator = document.getElementById('faceIndicator');
    const faceStatus = document.getElementById('faceStatus');
    const qualityIndicators = document.getElementById('qualityIndicators');
    const validationResult = document.getElementById('validationResult');

    let stream = null;
    let faceDetectionInterval = null;

    async function initWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                }
            });

            let cameraInitialized = false;
            function onCameraReady() {
                if (cameraInitialized) return;
                cameraInitialized = true;
                webcamOverlay.style.display = 'none';
                captureBtn.disabled = false;
                faceIndicator.style.display = 'flex';
                qualityIndicators.style.display = 'block';
                startFaceDetection();
            }

            webcam.addEventListener('canplay', onCameraReady);
            webcam.srcObject = stream;

            webcam.play().then(() => {
                onCameraReady();
            }).catch(err => {
                console.warn('Autoplay was prevented:', err);
                onCameraReady();
            });
        } catch (err) {
            console.error('Error accessing webcam:', err);
            webcamOverlay.innerHTML = `
                <div class="text-center text-white">
                    <i class="bi bi-camera-video-off" style="font-size: 4rem;"></i>
                    <p class="mt-3 mb-1 fw-medium">Camera not available</p>
                    <small class="opacity-75">Please upload an image instead</small>
                </div>
            `;
        }
    }

    function updateQualityBar(barId, valueId, percentage) {
        const bar = document.getElementById(barId);
        const value = document.getElementById(valueId);
        bar.style.width = percentage + '%';
        value.textContent = percentage + '%';

        bar.classList.remove('good', 'medium', 'poor');
        if (percentage >= 70) {
            bar.classList.add('good');
        } else if (percentage >= 40) {
            bar.classList.add('medium');
        } else {
            bar.classList.add('poor');
        }
    }

    function startFaceDetection() {
        faceDetectionInterval = setInterval(async () => {
            if (webcam.paused || webcam.ended) return;

            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;
            canvas.getContext('2d').drawImage(webcam, 0, 0);
            const tempImageData = canvas.toDataURL('image/jpeg', 0.5);

            try {
                const response = await fetch('/api/detect-face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: tempImageData })
                });
                const result = await response.json();

                if (result.success && result.face_detected) {
                    faceIndicator.className = 'face-indicator face-detected';
                    faceStatus.textContent = `Face detected (${Math.round(result.confidence * 100)}%)`;

                    updateQualityBar('brightnessBar', 'brightnessValue', 80);
                    updateQualityBar('sharpnessBar', 'sharpnessValue', 70);
                    updateQualityBar('faceSizeBar', 'faceSizeValue', result.confidence > 0.9 ? 90 : 60);
                } else {
                    faceIndicator.className = 'face-indicator face-not-detected';
                    faceStatus.textContent = 'No face detected';
                }
            } catch (e) {
                // Silently fail on detection errors
            }
        }, 1500);
    }

    initWebcam();

    captureBtn.addEventListener('click', async function() {
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        canvas.getContext('2d').drawImage(webcam, 0, 0);

        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        imageData.value = dataUrl;
        previewImage.src = dataUrl;
        capturedPreview.style.display = 'block';

        captureBtn.style.display = 'none';
        retakeBtn.style.display = 'block';

        if (faceDetectionInterval) {
            clearInterval(faceDetectionInterval);
        }

        await validateCapturedFace(dataUrl);
    });

    retakeBtn.addEventListener('click', function() {
        imageData.value = '';
        capturedPreview.style.display = 'none';
        validationResult.innerHTML = '';
        captureBtn.style.display = 'block';
        retakeBtn.style.display = 'none';
        submitBtn.disabled = true;
        startFaceDetection();
    });

    uploadImage.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async function(event) {
                imageData.value = event.target.result;
                previewImage.src = event.target.result;
                capturedPreview.style.display = 'block';
                await validateCapturedFace(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    async function validateCapturedFace(imageDataUrl) {
        validationResult.innerHTML = `
            <div class="d-flex align-items-center gap-2 text-muted">
                <span class="spinner-border spinner-border-sm"></span>
                <span>Validating face quality...</span>
            </div>
        `;
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/validate-face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageDataUrl })
            });
            const result = await response.json();

            if (result.success) {
                if (result.valid) {
                    validationResult.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle-fill"></i>
                                <strong>Face validated successfully!</strong>
                            </div>
                            <div class="small mt-1 opacity-75">
                                Resolution: ${result.quality_metrics.resolution} |
                                Confidence: ${Math.round(result.face_info.confidence * 100)}%
                            </div>
                        </div>
                    `;
                    submitBtn.disabled = false;
                } else {
                    let issuesHtml = result.issues.map(i => `<li>${i}</li>`).join('');
                    validationResult.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>Quality issues detected</strong>
                            </div>
                            <ul class="mb-0 mt-2 small">${issuesHtml}</ul>
                        </div>
                    `;
                    if (result.face_info && result.face_info.face_detected) {
                        submitBtn.disabled = false;
                    }
                }
            } else {
                validationResult.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        ${result.message || 'Could not validate face'}
                    </div>
                `;
            }
        } catch (e) {
            console.error('Validation error:', e);
            validationResult.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Could not validate face quality. You may still proceed.
                </div>
            `;
            submitBtn.disabled = false;
        }
    }

    enrollForm.addEventListener('submit', function(e) {
        if (!imageData.value) {
            e.preventDefault();
            alert('Please capture or upload a photo first.');
            return;
        }

        submitBtn.disabled = true;
        submitText.style.display = 'none';
        submitSpinner.style.display = 'inline';
    });
});
</script>
{% endblock %}
